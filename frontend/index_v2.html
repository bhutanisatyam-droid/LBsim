<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optical Link Budget Calculator (v2)</title>
    <meta name="description" content="Professional optical link budget calculator with PDF export">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2332 50%, #0d1b2a 100%);
            min-height: 100vh; padding: 20px; color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(0,0,0,0.6); border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,123,255,0.3); border: 1px solid rgba(0,123,255,0.2); }
        h1 { text-align: center; color: #007bff; margin-bottom: 10px; font-size: 2.5em; text-shadow: 0 0 20px rgba(0,123,255,0.5); }
        .subtitle { text-align: center; color: #6c757d; margin-bottom: 20px; font-size: 1.1em; }
        .api-status { text-align: center; padding: 10px; margin-bottom: 20px; border-radius: 8px; font-size: 0.9em; }
        .api-status.online { background: rgba(40,167,69,0.2); border: 1px solid rgba(40,167,69,0.5); color: #28a745; }
        .api-status.offline { background: rgba(220,53,69,0.2); border: 1px solid rgba(220,53,69,0.5); color: #dc3545; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .input-group { background: rgba(0,123,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(0,123,255,0.2); transition: all 0.3s ease; }
        .input-group:hover { background: rgba(0,123,255,0.1); border-color: rgba(0,123,255,0.4); transform: translateY(-2px); }
        .input-group.required label::after { content: " *"; color: #dc3545; }
        .input-group label { display: block; margin-bottom: 10px; color: #007bff; font-weight: 600; font-size: 0.95em; }
        .input-row { display: flex; gap: 10px; align-items: stretch; }
        .input-error { color: #dc3545; font-size: 0.85em; margin-top: 5px; display: none; }
        .input-error.show { display: block; }
        .value-input { flex: 2; }
        .unit-select { flex: 1; min-width: 100px; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid rgba(0,123,255,0.3); border-radius: 8px; background: rgba(0,0,0,0.4); color: #fff; font-size: 16px; transition: all 0.3s ease; }
        .input-group input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 15px rgba(0,123,255,0.3); }
        .input-group select { width: 100%; padding: 12px; border: 2px solid rgba(0,123,255,0.3); border-radius: 8px; background: rgba(0,0,0,0.4); color: #fff; font-size: 16px; cursor: pointer; }
        .input-group select option { background: #1a2332; color: #fff; }
        .button-group { display: flex; gap: 20px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        button { padding: 15px 40px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .calculate-btn { background: linear-gradient(135deg, #007bff, #0056b3); color: white; box-shadow: 0 5px 20px rgba(0,123,255,0.4); }
        .calculate-btn:hover:not(:disabled) { transform: translateY(-3px); }
        .reset-btn { background: linear-gradient(135deg, #343a40, #1a1d20); color: white; }
        .reset-btn:hover:not(:disabled) { transform: translateY(-3px); }
        .save-btn { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .save-btn:hover:not(:disabled) { transform: translateY(-3px); }
        .pdf-btn { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }
        .pdf-btn:hover:not(:disabled) { transform: translateY(-3px); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .results { background: rgba(0,123,255,0.05); border: 2px solid rgba(0,123,255,0.3); border-radius: 15px; padding: 30px; margin-top: 30px; display: none; }
        .results.show { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .results h2 { color: #007bff; margin-bottom: 20px; text-align: center; font-size: 1.8em; }
        .result-section { margin-bottom: 30px; }
        .result-section h3 { color: #0056b3; margin-bottom: 15px; font-size: 1.3em; border-bottom: 2px solid rgba(0,123,255,0.3); padding-bottom: 10px; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .result-item { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 10px; border-left: 4px solid #007bff; }
        .result-item.highlight { border-left: 4px solid #28a745; background: rgba(40,167,69,0.1); }
        .result-item.warning { border-left: 4px solid #dc3545; background: rgba(220,53,69,0.1); }
        .result-item .label { color: #6c757d; font-size: 0.9em; margin-bottom: 8px; }
        .result-item .value { color: #007bff; font-size: 1.3em; font-weight: 700; }
        .result-item.highlight .value { color: #28a745; }
        .result-item.warning .value { color: #dc3545; }
        .link-margin-box { background: linear-gradient(135deg, rgba(40,167,69,0.2), rgba(40,167,69,0.1)); border: 3px solid #28a745; border-radius: 15px; padding: 30px; text-align: center; margin: 30px 0; }
        .link-margin-box.negative { background: linear-gradient(135deg, rgba(220,53,69,0.2), rgba(220,53,69,0.1)); border-color: #dc3545; }
        .link-margin-box .title { font-size: 1.2em; color: #6c757d; margin-bottom: 10px; }
        .link-margin-box .margin-value { font-size: 3em; font-weight: 900; color: #28a745; }
        .link-margin-box.negative .margin-value { color: #dc3545; }
        .link-margin-box .status { font-size: 1.5em; font-weight: 700; margin-top: 15px; color: #28a745; }
        .link-margin-box.negative .status { color: #dc3545; }
        .lm-power-details { margin-top: 15px; font-size: 0.9em; color: #b0b0b0; text-align: left; display: inline-block; }
        .lm-power-details div { margin: 6px 0; }
        .error { background: rgba(220,53,69,0.1); border: 2px solid rgba(220,53,69,0.5); color: #dc3545; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; text-align: center; }
        .error.show { display: block; }
        .success { background: rgba(40,167,69,0.1); border: 2px solid rgba(40,167,69,0.5); color: #28a745; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; text-align: center; }
        .success.show { display: block; }
        @media (max-width: 768px) { .container { padding: 20px; } h1 { font-size: 1.8em; } .form-grid { grid-template-columns: 1fr; } .button-group { flex-direction: column; } button { width: 100%; } }
        .toggle-group { display: inline-flex; background: rgba(0,0,0,0.5); border-radius: 25px; padding: 3px; border: 1px solid rgba(0,123,255,0.3); margin-bottom: 12px; }
        .toggle-group input[type="radio"] { display: none; }
        .toggle-group label { padding: 8px 18px; border-radius: 22px; cursor: pointer; font-size: 0.85em; font-weight: 500; color: #8899aa; transition: all 0.3s ease; user-select: none; white-space: nowrap; }
        .toggle-group input[type="radio"]:checked+label { background: linear-gradient(135deg, #007bff, #0056b3); color: #fff; }
        .lna-badge { display: inline-block; background: rgba(0,123,255,0.2); border: 1px solid rgba(0,123,255,0.4); color: #007bff; font-size: 0.75em; padding: 2px 8px; border-radius: 10px; margin-left: 6px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Optical Link Budget Calculator</h1>
    <p class="subtitle">Professional calculation tool with PDF export and save functionality</p>
    <div id="apiStatus" class="api-status offline">‚ö†Ô∏è Backend API: Checking connection...</div>

    <div class="form-grid">
        <div class="input-group required">
            <label for="txPower">Transmitter Power</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="txPower" class="value-input" placeholder="Enter value">
                <select id="txPowerUnit" class="unit-select"><option value="dBm">dBm</option><option value="mW">mW</option><option value="W">W</option></select>
            </div>
            <div class="input-error" id="txPower-error"></div>
        </div>

        <div class="input-group required">
            <label for="txEfficiency">Transmitter Efficiency</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="txEfficiency" class="value-input" placeholder="Enter value">
                <select id="txEfficiencyUnit" class="unit-select"><option value="%">%</option><option value="decimal">Decimal</option></select>
            </div>
            <div class="input-error" id="txEfficiency-error"></div>
        </div>

        <div class="input-group required">
            <label for="rxEfficiency">Receiver Efficiency</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="rxEfficiency" class="value-input" placeholder="Enter value">
                <select id="rxEfficiencyUnit" class="unit-select"><option value="%">%</option><option value="decimal">Decimal</option></select>
            </div>
            <div class="input-error" id="rxEfficiency-error"></div>
        </div>

        <div class="input-group required">
            <label for="rxSensitivity">Receiver Sensitivity</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="rxSensitivity" class="value-input" placeholder="e.g., -60">
                <select id="rxSensitivityUnit" class="unit-select"><option value="dBm">dBm</option><option value="mW">mW</option><option value="W">W</option></select>
            </div>
            <div class="input-error" id="rxSensitivity-error"></div>
        </div>

        <!-- Rx Optical LNA Gain -->
        <div class="input-group required">
            <label for="rxLnaGain">Receiver Optical Low Noise Amplifier Gain Value</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="rxLnaGain" class="value-input" placeholder="0 (enter 0 if no LNA)">
                <select id="rxLnaGainUnit" class="unit-select"><option value="dB">dB</option></select>
            </div>
            <div class="input-error" id="rxLnaGain-error"></div>
        </div>

        <div class="input-group required">
            <label for="wavelength">Optical Wavelength</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="wavelength" class="value-input" placeholder="Enter value">
                <select id="wavelengthUnit" class="unit-select"><option value="nm">nm</option><option value="Œºm">Œºm</option><option value="m">m</option></select>
            </div>
            <div class="input-error" id="wavelength-error"></div>
        </div>

        <div class="input-group required">
            <label for="txDiameter">Transmitter Diameter</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="txDiameter" class="value-input" placeholder="Enter value">
                <select id="txDiameterUnit" class="unit-select"><option value="m">m</option><option value="cm">cm</option><option value="mm">mm</option></select>
            </div>
            <div class="input-error" id="txDiameter-error"></div>
        </div>

        <div class="input-group required">
            <label for="rxDiameter">Receiver Diameter</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="rxDiameter" class="value-input" placeholder="Enter value">
                <select id="rxDiameterUnit" class="unit-select"><option value="m">m</option><option value="cm">cm</option><option value="mm">mm</option></select>
            </div>
            <div class="input-error" id="rxDiameter-error"></div>
        </div>

        <div class="input-group required">
            <label for="distance">Distance (Transmitter to Receiver)</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="distance" class="value-input" placeholder="Enter value">
                <select id="distanceUnit" class="unit-select"><option value="m">m</option><option value="km">km</option><option value="cm">cm</option></select>
            </div>
            <div class="input-error" id="distance-error"></div>
        </div>

        <div class="input-group">
            <label for="implLoss">Implementation Loss (Optional)</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="implLoss" class="value-input" placeholder="0">
                <select id="implLossUnit" class="unit-select"><option value="dB">dB</option><option value="linear">Linear</option></select>
            </div>
            <div class="input-error" id="implLoss-error"></div>
        </div>

        <div class="input-group">
            <label for="couplingLoss">Coupling Loss (Optional)</label>
            <div class="input-row">
                <input type="text" inputmode="decimal" id="couplingLoss" class="value-input" placeholder="0">
                <select id="couplingLossUnit" class="unit-select"><option value="dB">dB</option><option value="linear">Linear</option></select>
            </div>
            <div class="input-error" id="couplingLoss-error"></div>
        </div>

        <div class="input-group">
            <label>Transmitter Pointing</label>
            <div class="toggle-group">
                <input type="radio" name="txPointingMode" value="manual" id="txModeManual" checked onchange="togglePointingMode('tx')">
                <label for="txModeManual">Manual Loss (dB)</label>
                <input type="radio" name="txPointingMode" value="error" id="txModeError" onchange="togglePointingMode('tx')">
                <label for="txModeError">Pointing Error</label>
            </div>
            <div id="txPointingManualInput">
                <div class="input-row">
                    <input type="text" inputmode="decimal" id="txPointingLoss" class="value-input" placeholder="0">
                    <select id="txPointingLossUnit" class="unit-select"><option value="dB">dB</option><option value="linear">Linear</option></select>
                </div>
            </div>
            <div id="txPointingErrorInput" style="display:none;">
                <div class="input-row">
                    <input type="text" inputmode="decimal" id="txPointingError" class="value-input" placeholder="Enter error">
                    <select id="txPointingErrorUnit" class="unit-select"><option value="urad">Œºrad</option><option value="rad">rad</option><option value="nrad">nrad</option></select>
                </div>
                <div style="font-size:0.8em;color:#aaa;margin-top:5px;">Calculated Loss: L = exp(-G_tx * Œ∏¬≤)</div>
            </div>
            <div class="input-error" id="txPointingLoss-error"></div>
        </div>

        <div class="input-group">
            <label>Receiver Pointing</label>
            <div class="toggle-group">
                <input type="radio" name="rxPointingMode" value="manual" id="rxModeManual" checked onchange="togglePointingMode('rx')">
                <label for="rxModeManual">Manual Loss (dB)</label>
                <input type="radio" name="rxPointingMode" value="error" id="rxModeError" onchange="togglePointingMode('rx')">
                <label for="rxModeError">Pointing Error</label>
            </div>
            <div id="rxPointingManualInput">
                <div class="input-row">
                    <input type="text" inputmode="decimal" id="rxPointingLoss" class="value-input" placeholder="0">
                    <select id="rxPointingLossUnit" class="unit-select"><option value="dB">dB</option><option value="linear">Linear</option></select>
                </div>
            </div>
            <div id="rxPointingErrorInput" style="display:none;">
                <div class="input-row">
                    <input type="text" inputmode="decimal" id="rxPointingError" class="value-input" placeholder="Enter error">
                    <select id="rxPointingErrorUnit" class="unit-select"><option value="urad">Œºrad</option><option value="rad">rad</option><option value="nrad">nrad</option></select>
                </div>
                <div style="font-size:0.8em;color:#aaa;margin-top:5px;">Calculated Loss: L = exp(-G_rx * Œ∏¬≤)</div>
            </div>
            <div class="input-error" id="rxPointingLoss-error"></div>
        </div>
    </div>

    <div class="button-group">
        <button class="calculate-btn" onclick="calculateLinkBudget()" id="calculateBtn">Calculate</button>
        <button class="reset-btn" onclick="resetForm()">Reset</button>
        <button class="save-btn" onclick="saveCalculation()" id="saveBtn" disabled>Save Calculation</button>
        <button class="pdf-btn" onclick="exportToPDF()" id="pdfBtn" disabled>Export to PDF</button>
    </div>

    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>

    <div class="results" id="results">
        <h2>Calculation Results</h2>

        <div id="linkMarginBox" class="link-margin-box">
            <div class="title">Link Margin (After LNA)</div>
            <div class="margin-value" id="linkMarginValue">0.00 dB</div>
            <div class="status" id="linkStatus">LINK STATUS</div>
            <div class="lm-power-details">
                <div>üì° Rx Power (No LNA): <span id="lmRxPowerNoLna">-</span></div>
                <div>üîä Rx Power (With LNA): <span id="lmRxPowerLna">-</span></div>
                <div>üéØ Required Sensitivity: <span id="lmSensitivity">-</span></div>
            </div>
        </div>

        <div class="result-section">
            <h3>Input Parameters</h3>
            <div class="result-grid">
                <div class="result-item"><div class="label">Transmitter Power</div><div class="value" id="resultTxPower">-</div></div>
                <div class="result-item"><div class="label">Receiver Sensitivity</div><div class="value" id="resultRxSensitivity">-</div></div>
                <div class="result-item"><div class="label">Distance</div><div class="value" id="resultDistance">-</div></div>
                <div class="result-item"><div class="label">Wavelength</div><div class="value" id="resultWavelength">-</div></div>
            </div>
        </div>

        <div class="result-section">
            <h3>Antenna Gains</h3>
            <div class="result-grid">
                <div class="result-item"><div class="label">Transmitter Gain</div><div class="value" id="resultTxGain">-</div></div>
                <div class="result-item"><div class="label">Receiver Gain</div><div class="value" id="resultRxGain">-</div></div>
            </div>
        </div>

        <div class="result-section">
            <h3>Beam Divergence</h3>
            <div class="result-grid">
                <div class="result-item"><div class="label">Tx Beam Divergence</div><div class="value" id="resultTxDivergence">-</div></div>
                <div class="result-item"><div class="label">Rx Beam Divergence</div><div class="value" id="resultRxDivergence">-</div></div>
            </div>
        </div>

        <div class="result-section">
            <h3>Losses</h3>
            <div class="result-grid">
                <div class="result-item"><div class="label">Path Loss</div><div class="value" id="resultPathLoss">-</div></div>
                <div class="result-item"><div class="label">Total Losses</div><div class="value" id="resultTotalLoss">-</div></div>
            </div>
        </div>

        <div class="result-section">
            <h3>Power Budget</h3>
            <div class="result-grid">
                <div class="result-item"><div class="label">Rx Power (Without LNA)</div><div class="value" id="resultRxPowerNoLna">-</div></div>
                <div class="result-item highlight"><div class="label">Rx Power (With LNA)</div><div class="value" id="resultRxPowerLna">-</div></div>
                <div class="result-item" id="resultLinkMarginItem"><div class="label">Link Margin (After LNA)</div><div class="value" id="resultLinkMarginSmall">-</div></div>
                <div class="result-item"><div class="label">Efficiencies</div><div class="value" id="resultEfficiencies">-</div></div>
            </div>
        </div>
    </div>
</div>
<script src="app_v2.js"></script>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for (let r of registrations) r.unregister();
        });
    }
</script>
</body>
</html>
